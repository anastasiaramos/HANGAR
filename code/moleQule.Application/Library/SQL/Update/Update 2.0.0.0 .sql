/* UPDATE 2.0.0.0*/

SET SEARCH_PATH = "COMMON";

UPDATE "Variable" SET "VALUE" = '2.0.0.0' WHERE "NAME" = 'DB_VERSION';

INSERT INTO "Variable" ("NAME", "VALUE") VALUES ('INSTRUCCION_SERIE', '1');
INSERT INTO "Variable" ("NAME", "VALUE") VALUES ('INSTRUCCION_PRODUCTO', '1');

ALTER TABLE "Empresa" ADD COLUMN "P_IRPF" decimal(10,2);

INSERT INTO "COMMON"."Variable" ("NAME", "VALUE") VALUES ('LINK_SEED', 'iQiQiQiQiQiQiQiQiQ');

ALTER TABLE "Despachante" DROP COLUMN "IGIC";

ALTER TABLE "Serie" DROP CONSTRAINT "Serie_TIPO_SERIE_key";

SET SEARCH_PATH = "0001";

ALTER TABLE "PlantillaExamen" ADD COLUMN "NOMBRE" varchar;
ALTER TABLE "Empleado" DROP COLUMN "OID_IMPUESTO";
ALTER TABLE "Empleado" ADD COLUMN "OID_IMPUESTO" bigint DEFAULT 1;


CREATE TABLE "Concepto_Parte"
( 
	"OID" bigserial NOT NULL,	
	"OID_CONCEPTO" int8 NOT NULL,
	"OID_PARTE" int8 NOT NULL,
	CONSTRAINT "CONCEPTO_PARTE_PK" PRIMARY KEY ("OID")
) WITHOUT OIDS;

ALTER TABLE "Concepto_Parte" OWNER TO hangar_admin;
GRANT ALL ON TABLE "Concepto_Parte" TO GROUP "HANGAR_ADMINISTRADOR";

ALTER TABLE "Concepto_Parte" ADD  CONSTRAINT fk_concepto_parte_concepto 
FOREIGN KEY ("OID_CONCEPTO") REFERENCES "ConceptoAlbaranProveedor" ("OID") MATCH SIMPLE 
ON UPDATE CASCADE ON DELETE CASCADE;	

ALTER TABLE "Concepto_Parte" ADD  CONSTRAINT fk_concepto_parte_parte 
FOREIGN KEY ("OID_PARTE") REFERENCES "ParteAsistencia" ("OID") MATCH SIMPLE 
ON UPDATE CASCADE ON DELETE CASCADE;

ALTER TABLE "Stock" ADD COLUMN "TIPO" bigint DEFAULT 1;
ALTER TABLE "Stock" ADD COLUMN "INICIAL" boolean DEFAULT FALSE;
ALTER TABLE "Stock" DROP COLUMN "N_FACTURA";

UPDATE "Stock" SET "INICIAL" = TRUE WHERE "CONCEPTO" = 'Entrada inicial';

UPDATE "Stock" SET "TIPO" = 1 WHERE "KILOS" > 0 AND "OID_ALBARAN" > 0;
UPDATE "Stock" SET "TIPO" = 2 WHERE "KILOS" < 0 AND "OID_ALBARAN" > 0;
UPDATE "Stock" SET "TIPO" = 3 WHERE "KILOS" > 0 AND "OID_ALBARAN" = 0;
UPDATE "Stock" SET "TIPO" = 4 WHERE "KILOS" < 0 AND "OID_ALBARAN" = 0;

ALTER TABLE "Empleado" ADD COLUMN "CUENTA_ASOCIADA" varchar(255);

ALTER TABLE "Cabeza" ADD CONSTRAINT "FK_Cabeza_Producto_Expediente" FOREIGN KEY ("OID_PRODUCTO_EXPEDIENTE") REFERENCES "Producto_Expediente" ("OID") ON UPDATE CASCADE ON DELETE CASCADE;
ALTER TABLE "Maquinaria" ADD CONSTRAINT "FK_Maquinaria_Producto_Expediente" FOREIGN KEY ("OID_PRODUCTO_EXPEDIENTE") REFERENCES "Producto_Expediente" ("OID") ON UPDATE CASCADE ON DELETE CASCADE;

ALTER TABLE "Stock" DROP CONSTRAINT "FK_Stock_Producto_Expediente";
ALTER TABLE "Stock" ADD CONSTRAINT "FK_Stock_Producto_Expediente" FOREIGN KEY ("OID_PRODUCTO_EXPEDIENTE") REFERENCES "Producto_Expediente" ("OID")ON UPDATE CASCADE ON DELETE CASCADE;

ALTER TABLE "Gasto" ADD COLUMN "TIPO" bigint DEFAULT 1;
ALTER TABLE "Producto_Proveedor" ADD COLUMN "OID_IMPUESTO" bigint DEFAULT 0;

ALTER TABLE "Producto_Proveedor"DROP CONSTRAINT "FK_Proveedor_Producto_Proveedor";

ALTER TABLE "Producto" ADD COLUMN "UNITARIO" boolean DEFAULT FALSE;

ALTER TABLE "ParteAsistencia" ADD COLUMN "CONFIRMADA" boolean DEFAULT false;

ALTER TABLE "ParteAsistencia" ADD COLUMN "OID_INSTRUCTOR_EFECTIVO" int8 DEFAULT 0;

UPDATE "ParteAsistencia" SET "OID_INSTRUCTOR_EFECTIVO" = "OID_INSTRUCTOR" WHERE "OID_INSTRUCTOR_EFECTIVO" = 0;


