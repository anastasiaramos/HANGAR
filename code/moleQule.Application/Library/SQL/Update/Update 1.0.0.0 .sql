/* UPDATE 1.0.0.0*/

SET SEARCH_PATH = "COMMON";

CREATE SEQUENCE "Variable_OID_seq";

ALTER TABLE "Variable" ALTER COLUMN "OID" SET DEFAULT nextval(('"COMMON"."Variable_OID_seq"'::text)::regclass);
ALTER SEQUENCE "COMMON"."Variable_OID_seq" RESTART WITH 2;
INSERT INTO "Variable" ("NAME", "VALUE") VALUES ('DB_VERSION', '0.0.0.0');
UPDATE "Variable" SET "VALUE" = '1.0.0.0' WHERE "NAME" = 'DB_VERSION';

/*moleQule.Common*/

/* UPDATE 2.0.0.0*/

SET SEARCH_PATH = "COMMON";

ALTER TABLE "MUNICIPIO" ADD COLUMN "LOCALIDAD" varchar(255);
ALTER TABLE "MUNICIPIO" DROP CONSTRAINT "MUNICIPIO_VALOR_key" CASCADE;

UPDATE "MUNICIPIO" SET "LOCALIDAD" = "VALOR";

/* UPDATE 2.5.0.0*/

SET SEARCH_PATH = "COMMON";

ALTER TABLE "CUENTA_BANCARIA" ADD COLUMN "CUENTA_CONTABLE" text;
ALTER TABLE "CUENTA_BANCARIA" ADD COLUMN "CUENTA_CONTABLE_GASTOS" text;

CREATE TABLE "TarjetaCredito" ( 
	"OID" bigserial NOT NULL,
	"OID_CUENTA_BANCARIA" bigint NOT NULL,
	"NOMBRE" varchar(255) UNIQUE,
	"NUMERACION" varchar(255) UNIQUE,
	"CUENTA_CONTABLE" varchar(255),
	"OBSERVACIONES" text,
	CONSTRAINT "PK_TarjetaCredito" PRIMARY KEY ("OID")
) WITHOUT OIDS;

ALTER TABLE "TarjetaCredito" OWNER TO moladmin;
GRANT ALL ON TABLE "TarjetaCredito" TO GROUP "MOLEQULE_ADMINISTRATOR";

CREATE TABLE "TPV" ( 
	"OID" bigserial NOT NULL,
	"OID_CUENTA_BANCARIA" bigint NOT NULL,
	"NOMBRE" varchar(255) UNIQUE,
	"CUENTA_CONTABLE" varchar(255),
	"OBSERVACIONES" text,
	CONSTRAINT "PK_TPV" PRIMARY KEY ("OID")
) WITHOUT OIDS;

ALTER TABLE "TPV" OWNER TO moladmin;
GRANT ALL ON TABLE "TPV" TO GROUP "MOLEQULE_ADMINISTRATOR";

CREATE TABLE "Impuesto" ( 
	"OID" bigserial NOT NULL,
	"NOMBRE" varchar(255) UNIQUE,
	"PORCENTAJE" decimal(10,2) DEFAULT 0,
	"CUENTA_CONTABLE_REPERCUTIDO" varchar(255),
	"CUENTA_CONTABLE_SOPORTADO" varchar(255),
	"OBSERVACIONES" text,
	CONSTRAINT "PK_Impuesto" PRIMARY KEY ("OID")
) WITHOUT OIDS;

ALTER TABLE "Impuesto" OWNER TO moladmin;
GRANT ALL ON TABLE "Impuesto" TO GROUP "MOLEQULE_ADMINISTRATOR";

ALTER TABLE "TarjetaCredito" ADD CONSTRAINT "FK_TarjetaCredito_CuentaBancaria" FOREIGN KEY ("OID_CUENTA_BANCARIA") REFERENCES "COMMON"."CUENTA_BANCARIA" ("OID")ON UPDATE CASCADE ON DELETE RESTRICT;
ALTER TABLE "TPV" ADD CONSTRAINT "FK_TPV_CuentaBancaria" FOREIGN KEY ("OID_CUENTA_BANCARIA") REFERENCES "COMMON"."CUENTA_BANCARIA" ("OID")ON UPDATE CASCADE ON DELETE RESTRICT;

SET SEARCH_PATH = "0001";

/* UPDATE 3.0.0.0*/

SET SEARCH_PATH = "COMMON";

ALTER TABLE "TarjetaCredito" ADD COLUMN "TIPO" bigint DEFAULT 1;

SET SEARCH_PATH = "0001";

/*moleQule.Library.Invoice*/

/* UPDATE 2.0.2.0*/

SET SEARCH_PATH = "COMMON";

SET SEARCH_PATH = "0001";

ALTER TABLE "LineaCaja" ADD COLUMN "OID_CUENTA_BANCARIA" int8 DEFAULT 0;

/* UPDATE 2.0.3.0*/

SET SEARCH_PATH = "COMMON";

SET SEARCH_PATH = "0001";

ALTER TABLE "Factura" ADD COLUMN "ESTADO" int8 DEFAULT 1;

UPDATE "Factura" SET "ESTADO" = 2;

/* UPDATE 2.0.3.2*/

SET SEARCH_PATH = "COMMON";

--ALTER TABLE "Cliente" ADD COLUMN "OID_CUENTA_BANCARIA_ASOCIADA" int8 DEFAULT 0;

UPDATE "Cliente" SET "OID_CUENTA_BANCARIA_ASOCIADA" = CB."OID"
FROM "CUENTA_BANCARIA" AS CB 
WHERE "Cliente"."CUENTA_ASOCIADA" = CB."VALOR";

ALTER TABLE "Cliente" DROP COLUMN "CUENTA_ASOCIADA";

SET SEARCH_PATH = "0001";

--ALTER TABLE "Cobro" ADD COLUMN "OID_CUENTA_BANCARIA" int8 DEFAULT 0;
--ALTER TABLE "Cobro" DROP COLUMN "NUMERO";
--ALTER TABLE "Cobro" DROP COLUMN "SUCURSAL";

UPDATE "Cobro" SET "OID_CUENTA_BANCARIA" = CB."OID"
FROM "COMMON"."CUENTA_BANCARIA" AS CB 
WHERE "Cobro"."CUENTA" = CB."VALOR";

ALTER TABLE "Cobro" DROP COLUMN "CUENTA";

/* UPDATE 2.1.0.0*/

SET SEARCH_PATH = "COMMON";

SET SEARCH_PATH = "0001";

ALTER TABLE "Cobro" ADD COLUMN "SERIAL" int8 DEFAULT 0 NOT NULL;
ALTER TABLE "Cobro" ADD COLUMN "CODIGO" varchar(255);

UPDATE "Cobro" 
SET "SERIAL" = C."NROW", "CODIGO" = trim(to_char(C."NROW", '000000'))
FROM (SELECT "OID", ROW_NUMBER() OVER (ORDER BY "FECHA", "ID_COBRO") AS "NROW"
     FROM "0001"."Cobro" 
     ORDER BY "FECHA", "ID_COBRO") AS C
WHERE "Cobro"."OID" = C."OID";

/*moleQule.Library.Store*/

/* UPDATE 2.0.2.0*/

SET SEARCH_PATH = "COMMON";

SET SEARCH_PATH = "0001";

--ALIMENTACION
UPDATE "FacturaProveedor" SET "OID_SERIE" = 1 
FROM "Expediente", "Gasto"
WHERE "FacturaProveedor"."OID" = "Gasto"."OID_FACTURA" 
AND "Expediente"."OID" = "Gasto"."OID_EXPEDIENTE"
AND "TIPO_EXPEDIENTE" = 2;

--MAQUINARIA
UPDATE "FacturaProveedor" SET "OID_SERIE" = 2 
FROM "Expediente", "Gasto"
WHERE "FacturaProveedor"."OID" = "Gasto"."OID_FACTURA" 
AND "Expediente"."OID" = "Gasto"."OID_EXPEDIENTE"
AND "TIPO_EXPEDIENTE" = 3;

--GANADO
UPDATE "FacturaProveedor" SET "OID_SERIE" = 6 
FROM "Expediente", "Gasto"
WHERE "FacturaProveedor"."OID" = "Gasto"."OID_FACTURA" 
AND "Expediente"."OID" = "Gasto"."OID_EXPEDIENTE"
AND "TIPO_EXPEDIENTE" = 4;

ALTER TABLE "Expediente" ADD COLUMN "AYUDAS" decimal(10,2) DEFAULT 0;
ALTER TABLE "FacturaProveedor" ADD COLUMN "FECHA_REGISTRO" date;

UPDATE "Expediente" SET "TIPO_EXPEDIENTE" = 5 WHERE "TIPO_EXPEDIENTE" = 4; 
UPDATE "Expediente" SET "TIPO_EXPEDIENTE" = 4 WHERE "TIPO_EXPEDIENTE" = 3; 
UPDATE "Expediente" SET "TIPO_EXPEDIENTE" = 3 WHERE "TIPO_EXPEDIENTE" = 2; 
UPDATE "Expediente" SET "TIPO_EXPEDIENTE" = 2 WHERE "TIPO_EXPEDIENTE" = 1; 
UPDATE "Expediente" SET "TIPO_EXPEDIENTE" = 1 WHERE "TIPO_EXPEDIENTE" = 0; 

/* UPDATE 2.0.4.0*/

SET SEARCH_PATH = "COMMON";

SET SEARCH_PATH = "0001";

ALTER TABLE "Producto_Expediente" ADD COLUMN "GASTO_KILO" decimal(10,5) DEFAULT 0;

ALTER TABLE "FacturaProveedor" ADD COLUMN "ESTADO" int8 DEFAULT 1;

/* UPDATE 2.1.0.0*/

SET SEARCH_PATH = "COMMON";

SET SEARCH_PATH = "0001";

ALTER TABLE "Expediente" ADD COLUMN "ID_ENVIO" varchar(255);

ALTER TABLE "Pago" ADD COLUMN "SERIAL" int8 DEFAULT 0 NOT NULL;
ALTER TABLE "Pago" ADD COLUMN "CODIGO" varchar(255);

UPDATE "Pago" 
SET "SERIAL" = C."NROW", "CODIGO" = trim(to_char(C."NROW", '000000'))
FROM (SELECT "OID", ROW_NUMBER() OVER (ORDER BY "FECHA", "ID_PAGO") AS "NROW"
     FROM "0001"."Pago" 
     ORDER BY "FECHA", "ID_PAGO") AS C
WHERE "Pago"."OID" = C."OID";

ALTER TABLE "AlbaranProveedor" ADD CONSTRAINT "AlbaranProveedor_SERIAL_OID_SERIE_key" UNIQUE("SERIAL", "OID_SERIE");

/* UPDATE 2.1.2.0*/

SET SEARCH_PATH = "COMMON";

SET SEARCH_PATH = "0001";

ALTER TABLE "Pago" ALTER COLUMN "FECHA" TYPE timestamp without time zone;

DROP TABLE IF EXISTS "AlbaranProveedor" CASCADE;
CREATE TABLE "AlbaranProveedor" ( 
	"OID" bigserial NOT NULL,
	"OID_SERIE" int8,
	"OID_ACREEDOR" int8,
	"TIPO_ACREEDOR" int8,
	"SERIAL" int8 DEFAULT 0 NOT NULL UNIQUE,
	"CODIGO" varchar(255),
	"ANO" int8,
	"FECHA" date,
	"FECHA_REGISTRO" date,
	"FORMA_PAGO" bigint DEFAULT 1,
	"DIAS_PAGO" bigint DEFAULT 0,
	"MEDIO_PAGO" bigint DEFAULT 1,
	"PREVISION_PAGO" date,
	"P_IRPF" numeric(10,2),
	"P_DESCUENTO" decimal(10,2),
	"DESCUENTO" decimal(10,2) default 0,
	"BASE_IMPONIBLE" decimal(10,2),
	"IGIC" decimal(10,2),
	"TOTAL" decimal(10,2),
	"CUENTA_BANCARIA" varchar(255),
	"NOTA" boolean,
	"OBSERVACIONES" text,
	"CONTADO" boolean NOT NULL DEFAULT false,
	"RECTIFICATIVO" boolean DEFAULT false,
	CONSTRAINT "PK_AlbaranProveedor" PRIMARY KEY ("OID")	
) WITHOUT OIDS;

ALTER TABLE "AlbaranProveedor" ADD CONSTRAINT "AlbaranProveedor_SERIAL_OID_SERIE_key" UNIQUE("SERIAL", "OID_SERIE");
ALTER TABLE "AlbaranProveedor" OWNER TO moladmin;
GRANT ALL ON TABLE "AlbaranProveedor" TO GROUP "MOLEQULE_ADMINISTRATOR";

/*CREATE TABLE "Albaran_FacturaProveedor" 
( 
	"OID" bigserial NOT NULL,
	"OID_ALBARAN" int8 NOT NULL,
	"OID_FACTURA" int8 NOT NULL,
	"FECHA_ASIGNACION" date,
	CONSTRAINT "PK_Albaran_FacturaProveedor" PRIMARY KEY ("OID")
) WITHOUT OIDS;

ALTER TABLE "Albaran_FacturaProveedor" ADD CONSTRAINT "UQ_Albaran_Factura_OID_ALBARAN_OID_FACTURA" UNIQUE("OID_ALBARAN", "OID_FACTURA");
ALTER TABLE "Albaran_FacturaProveedor" OWNER TO moladmin;
GRANT ALL ON TABLE "Albaran_FacturaProveedor" TO GROUP "MOLEQULE_ADMINISTRATOR";

DROP TABLE IF EXISTS "ConceptoAlbaranProveedor";
CREATE TABLE "ConceptoAlbaranProveedor" ( 
	"OID" bigserial NOT NULL,
	"OID_ALBARAN" int8,
	"OID_PRODUCTO_EXPEDIENTE" int8,
	"OID_EXPEDIENTE" int8,
	"OID_PRODUCTO" int8,
	"OID_KIT" bigint NOT NULL DEFAULT 0,
	"CODIGO_EXPEDIENTE" varchar(255),
	"CONCEPTO" varchar(255),
	"FACTURACION_BULTO" boolean,
	"CANTIDAD" decimal(10,2),
	"CANTIDAD_BULTOS" numeric(10,4),
	"P_IGIC" decimal(10,2),
	"P_DESCUENTO" decimal(10,2),
	"TOTAL" decimal(10,2),
	"PRECIO" decimal(10,5),
	"SUBTOTAL" decimal(10,2),
	"GASTOS" decimal(10,5),
	CONSTRAINT "PK_ConceptoAlbaranProveedor" PRIMARY KEY ("OID")
) WITHOUT OIDS;

ALTER TABLE "ConceptoAlbaranProveedor" OWNER TO moladmin;
GRANT ALL ON TABLE "ConceptoAlbaranProveedor" TO GROUP "MOLEQULE_ADMINISTRATOR";*/

ALTER TABLE "AlbaranProveedor" ADD CONSTRAINT "FK_AlbaranProveedor_Serie" FOREIGN KEY ("OID_SERIE") REFERENCES "COMMON"."Serie" ("OID")ON UPDATE CASCADE ON DELETE RESTRICT ;
ALTER TABLE "Albaran_FacturaProveedor" ADD CONSTRAINT "FK_Albaran_FacturaProveedor_AlbaranProveedor" FOREIGN KEY ("OID_ALBARAN") REFERENCES "AlbaranProveedor" ("OID") ON UPDATE CASCADE ON DELETE RESTRICT;
ALTER TABLE "Albaran_FacturaProveedor" ADD CONSTRAINT "FK_Albaran_FacturaProveedor_FacturaProveedor" FOREIGN KEY ("OID_FACTURA") REFERENCES "FacturaProveedor" ("OID") ON UPDATE CASCADE ON DELETE CASCADE;
ALTER TABLE "ConceptoAlbaranProveedor" ADD CONSTRAINT "FK_ConceptoAlbaranProveedor_AlbaranProveedor" FOREIGN KEY ("OID_ALBARAN") REFERENCES "AlbaranProveedor" ("OID")ON UPDATE CASCADE ON DELETE CASCADE ;

/* UPDATE 2.5.0.0*/

SET SEARCH_PATH = "COMMON";

ALTER TABLE "Despachante" ADD COLUMN "CUENTA_CONTABLE" text;
ALTER TABLE "Naviera" ADD COLUMN "CUENTA_CONTABLE" text;
ALTER TABLE "Proveedor" ADD COLUMN "CUENTA_CONTABLE" text;
ALTER TABLE "Transportista" ADD COLUMN "CUENTA_CONTABLE" text;
ALTER TABLE "Familia" ADD COLUMN "CUENTA_CONTABLE" text;

SET SEARCH_PATH = "0001";

ALTER TABLE "Empleado" ADD COLUMN "CUENTA_CONTABLE" text;
ALTER TABLE "Producto" ADD COLUMN "OID_IMPUESTO" bigint;
ALTER TABLE "ConceptoAlbaranProveedor" ADD COLUMN "OID_IMPUESTO" bigint;
ALTER TABLE "ConceptoFacturaProveedor" ADD COLUMN "OID_IMPUESTO" bigint;
ALTER TABLE "Pago" ADD COLUMN "OID_TARJETA_CREDITO" bigint;


/*moleQule.Library.Instruction*/

SET SEARCH_PATH = "0001";

ALTER TABLE "Empleado" ADD COLUMN "OID_CUENTA_BANCARIA_ASOCIADA" int8 DEFAULT 0;

ALTER TABLE "Empleado" DROP COLUMN "CUENTA_ASOCIADA";

/*moleQule.Libary.Quality*/

SET search_path TO "0001";


CREATE TABLE "Plan_Tipo" ( 
	"OID" bigserial NOT NULL,
	"OID_PLAN" int8 NOT NULL,
	"OID_TIPO" int8 NOT NULL,	
	"ORDEN" int8 NOT NULL,
	CONSTRAINT "PLAN_TIPO_PK" PRIMARY KEY ("OID")
)WITHOUT OIDS
;
ALTER TABLE "Plan_Tipo" OWNER TO hangar_admin;
GRANT ALL ON TABLE "Plan_Tipo" TO GROUP "HANGAR_ADMINISTRADOR";


ALTER TABLE "Plan_Tipo" ADD CONSTRAINT FK_Plan_Tipo_TipoAuditoria 
	FOREIGN KEY ("OID_TIPO") REFERENCES "TipoAuditoria" ("OID")
ON UPDATE CASCADE ON DELETE RESTRICT
;

ALTER TABLE "Plan_Tipo" ADD CONSTRAINT FK_Plan_Tipo_PlanAnual 
	FOREIGN KEY ("OID_PLAN") REFERENCES "PlanAnual" ("OID")
ON UPDATE CASCADE ON DELETE RESTRICT
;

DROP TABLE "Plan_Clase";

ALTER TABLE "Auditoria" ADD COLUMN "OID_PLAN_TIPO" int8 NOT NULL;

ALTER TABLE "Auditoria" ADD CONSTRAINT FK_Auditoria_Plan_Tipo 
	FOREIGN KEY ("OID_PLAN_TIPO") REFERENCES "Plan_Tipo" ("OID")
ON UPDATE CASCADE ON DELETE RESTRICT
;

ALTER TABLE "Auditoria_Area" DROP CONSTRAINT fk_auditoria_area_auditoria;


ALTER TABLE "Auditoria_Area" ADD CONSTRAINT FK_Auditoria_Area_Auditoria 
	FOREIGN KEY ("OID_AUDITORIA") REFERENCES "TipoAuditoria" ("OID")
ON UPDATE CASCADE ON DELETE CASCADE
;

DROP TABLE "ComunicadoAuditoria";

CREATE TABLE "NotificacionInterna" 
( 
	"OID" bigserial NOT NULL,
	"OID_ASOCIADO" int8 NOT NULL,
	"TIPO_ASOCIADO" int8 NOT NULL,
	"CODIGO" varchar(255) NOT NULL,
	"SERIAL" int8 NOT NULL,
	"NUMERO" int8 NOT NULL,
	"COMENTARIOS" varchar,
	"ASUNTO" varchar NOT NULL,
	"FECHA" date NOT NULL,
	CONSTRAINT "NOTIFICACION_INTERNA_PK" PRIMARY KEY ("OID")
)WITHOUT OIDS
;
ALTER TABLE "NotificacionInterna" OWNER TO hangar_admin;
GRANT ALL ON TABLE "NotificacionInterna" TO GROUP "HANGAR_ADMINISTRADOR";

ALTER TABLE "TipoAuditoria" ADD COLUMN "TEXTO_INFORME" varchar;

ALTER TABLE "Discrepancia" ADD COLUMN "OID_CUESTION" int8 NOT NULL;

ALTER TABLE "Discrepancia" ADD CONSTRAINT FK_Discrepancia_CuestionAuditoria 
	FOREIGN KEY ("OID_CUESTION") REFERENCES "CuestionAuditoria" ("OID")
ON UPDATE CASCADE ON DELETE RESTRICT
;


INSERT INTO "COMMON"."Variable" ("NAME" , "VALUE") VALUES ('PLAZO_MAXIMO_AMPLIACION', '50');
INSERT INTO "COMMON"."Variable" ("NAME" , "VALUE") VALUES ('PLAZO_MAXIMO_GENERACION_INFORME', '14');
INSERT INTO "COMMON"."Variable" ("NAME" , "VALUE") VALUES ('PLAZO_MAXIMO_NOTIFICACION_DISCREPANCIAS', '7');
INSERT INTO "COMMON"."Variable" ("NAME" , "VALUE") VALUES ('PLAZO_MAXIMO_NOTIFICACION_FIN_AUDITORIA', '7');
INSERT INTO "COMMON"."Variable" ("NAME" , "VALUE") VALUES ('PLAZO_MAXIMO_DISCREPANCIAS_N1', '7');
INSERT INTO "COMMON"."Variable" ("NAME" , "VALUE") VALUES ('PLAZO_MAXIMO_DISCREPANCIAS_N2', '60');
INSERT INTO "COMMON"."Variable" ("NAME" , "VALUE") VALUES ('PLAZO_MAXIMO_DISCREPANCIAS_N3', '90');
INSERT INTO "COMMON"."Variable" ("NAME" , "VALUE") VALUES ('PLAZO_MAXIMO_RESPUESTA_AMPLIACION', '14');

ALTER TABLE "InformeDiscrepancia" DROP CONSTRAINT UQ_InformeDiscrepancia_NUMERO;
ALTER TABLE "NotificacionInterna" ADD COLUMN "ATENCION" varchar(255);
ALTER TABLE "NotificacionInterna" ADD COLUMN "COPIA" varchar(255);
ALTER TABLE "Plan_Tipo" ADD COLUMN "ENERO" boolean DEFAULT false;
ALTER TABLE "Plan_Tipo" ADD COLUMN "FEBRERO" boolean DEFAULT false;
ALTER TABLE "Plan_Tipo" ADD COLUMN "MARZO" boolean DEFAULT false;
ALTER TABLE "Plan_Tipo" ADD COLUMN "ABRIL" boolean DEFAULT false;
ALTER TABLE "Plan_Tipo" ADD COLUMN "MAYO" boolean DEFAULT false;
ALTER TABLE "Plan_Tipo" ADD COLUMN "JUNIO" boolean DEFAULT false;
ALTER TABLE "Plan_Tipo" ADD COLUMN "JULIO" boolean DEFAULT false;
ALTER TABLE "Plan_Tipo" ADD COLUMN "AGOSTO" boolean DEFAULT false;
ALTER TABLE "Plan_Tipo" ADD COLUMN "SEPTIEMBRE" boolean DEFAULT false;
ALTER TABLE "Plan_Tipo" ADD COLUMN "OCTUBRE" boolean DEFAULT false;
ALTER TABLE "Plan_Tipo" ADD COLUMN "NOVIEMBRE" boolean DEFAULT false;
ALTER TABLE "Plan_Tipo" ADD COLUMN "DICIEMBRE" boolean DEFAULT false;
ALTER TABLE "Discrepancia" ADD COLUMN "DISCREPANCIA" boolean DEFAULT true;
ALTER TABLE "InformeDiscrepancia" ADD COLUMN "NOTIFICADO" boolean DEFAULT false;
ALTER TABLE "InformeCorrector" ADD COLUMN "NOTIFICADO" boolean DEFAULT false;
ALTER TABLE "InformeAmpliacion" ADD COLUMN "NOTIFICADO" boolean DEFAULT false;

alter table "Discrepancia" drop CONSTRAINT fk_discrepancia_informediscrepancia;
alter table "Discrepancia" add constraint fk_discrepancia_informediscrepancia FOREIGN KEY ("OID_INFORME")
      REFERENCES "0001"."InformeDiscrepancia" ("OID") MATCH SIMPLE
      ON UPDATE CASCADE ON DELETE cascade;

alter table "AccionCorrectora" drop constraint fk_accioncorrectora_informecorrector;
alter table "AccionCorrectora" add CONSTRAINT fk_accioncorrectora_informecorrector FOREIGN KEY ("OID_INFORME_CORRECTOR")
      REFERENCES "0001"."InformeCorrector" ("OID") MATCH SIMPLE
      ON UPDATE CASCADE ON DELETE cascade;

alter table "Ampliacion" drop constraint fk_ampliacion_informeampliacion;
alter table "Ampliacion" add CONSTRAINT fk_ampliacion_informeampliacion FOREIGN KEY ("OID_INFORME_AMPLIACION")
      REFERENCES "0001"."InformeAmpliacion" ("OID") MATCH SIMPLE
      ON UPDATE CASCADE ON DELETE cascade;
      
ALTER TABLE "InformeDiscrepancia" ADD COLUMN "TITULO" varchar;
ALTER TABLE "InformeCorrector" ADD COLUMN "TITULO" varchar;
ALTER TABLE "InformeAmpliacion" ADD COLUMN "TITULO" varchar;


SET SEARCH_PATH = 'COMMON';

INSERT INTO "COMMON"."TIPOENTIDAD" ("VALOR", "USER_CREATED", "COMMON_SCHEMA") VALUES ('InformeDiscrepancia', FALSE, FALSE);
INSERT INTO "COMMON"."TIPOENTIDAD" ("VALOR", "USER_CREATED", "COMMON_SCHEMA") VALUES ('InformeCorrector', FALSE, FALSE);
INSERT INTO "COMMON"."TIPOENTIDAD" ("VALOR", "USER_CREATED", "COMMON_SCHEMA") VALUES ('InformeAmpliacion', FALSE, FALSE);

INSERT INTO "COMMON"."Entidad" ("TIPO") VALUES ('InformeDiscrepancia');
INSERT INTO "COMMON"."Entidad" ("TIPO") VALUES ('InformeCorrector');
INSERT INTO "COMMON"."Entidad" ("TIPO") VALUES ('InformeAmpliacion');


INSERT INTO "COMMON"."Variable" ("NAME" , "VALUE") VALUES ('AVISO_DISCREPANCIAS_ABIERTAS', '7');

SET search_path TO "0001";
      
ALTER TABLE "InformeDiscrepancia" ADD COLUMN "FECHA_CREACION" timestamp without time zone;
ALTER TABLE "InformeCorrector" ADD COLUMN "FECHA_CREACION" timestamp without time zone;
ALTER TABLE "InformeAmpliacion" ADD COLUMN "FECHA_CREACION" timestamp without time zone;

ALTER TABLE "InformeAmpliacion" ADD COLUMN "VALORADO" boolean DEFAULT false;

ALTER TABLE "PlanAnual" ADD COLUMN "ANO" int8;
ALTER TABLE "Auditoria" ADD COLUMN "FECHA_COMUNICACION" date;
ALTER TABLE "InformeDiscrepancia" ADD COLUMN "FECHA_COMUNICACION" date;
ALTER TABLE "InformeAmpliacion" ADD COLUMN "FECHA_COMUNICACION" date;
ALTER TABLE "InformeCorrector" ADD COLUMN "FECHA_COMUNICACION" date;


ALTER TABLE "InformeDiscrepancia" DROP COLUMN "NUMERO";
ALTER TABLE "InformeDiscrepancia" ADD COLUMN "NUMERO" varchar NOT NULL;
ALTER TABLE "InformeAmpliacion" DROP COLUMN "NUMERO";
ALTER TABLE "InformeAmpliacion" ADD COLUMN "NUMERO" varchar NOT NULL;
ALTER TABLE "InformeCorrector" DROP COLUMN "NUMERO";
ALTER TABLE "InformeCorrector" ADD COLUMN "NUMERO" varchar NOT NULL;
ALTER TABLE "Discrepancia" ADD COLUMN "FECHA_AMPLIACION" date NOT NULL;

INSERT INTO "COMMON"."TIPOENTIDAD" ("VALOR", "USER_CREATED", "COMMON_SCHEMA") VALUES ('ActaComite', FALSE, FALSE);

INSERT INTO "COMMON"."Entidad" ("TIPO") VALUES ('ActaComite');

/*moleQule.Library.Invoice*/

/* UPDATE 2.1.2.0*/

SET SEARCH_PATH = "COMMON";

ALTER TABLE "Cliente" ADD COLUMN "HISTORIA" text;
INSERT INTO "COMMON"."SecureItem" ("NAME") VALUES ('Movimientos a Bancos');

SET SEARCH_PATH = "0001";

ALTER TABLE "Cobro" ALTER COLUMN "FECHA" TYPE timestamp without time zone;

CREATE TABLE "MovimientoBanco" ( 
	"OID" bigserial  NOT NULL,
	"OID_OPERACION" int8 NOT NULL,
	"TIPO_OPERACION" int8 DEFAULT 0,
	"SERIAL" bigint UNIQUE,
	"CODIGO" varchar(255) UNIQUE,
	"OID_USUARIO" int8,
	"AUDITADO" bool DEFAULT FALSE,
	"OBSERVACIONES" text,
	CONSTRAINT "PK_MovimientoBanco" PRIMARY KEY ("OID")
) WITHOUT OIDS;

ALTER TABLE "MovimientoBanco" OWNER TO moladmin;
GRANT ALL ON TABLE "MovimientoBanco" TO moladmin;
GRANT ALL ON TABLE "MovimientoBanco" TO GROUP "MOLEQULE_ADMINISTRATOR";

INSERT INTO "Privilege" ("OID_USER", "OID_ITEM", "READ", "WRITE") 
	SELECT u."OID", i."OID", FALSE, FALSE FROM "COMMON"."User" AS u, "COMMON"."SecureItem" AS i
	WHERE (u."OID", i."OID") NOT IN (SELECT "OID_USER", "OID_ITEM" FROM "Privilege");	
	
TRUNCATE TABLE "MovimientoBanco";

ALTER TABLE "MovimientoBanco" ADD COLUMN "FECHA" timestamp without time zone;
	
INSERT INTO "MovimientoBanco" ("OID_OPERACION", "TIPO_OPERACION", "SERIAL", "CODIGO", "FECHA") 
	SELECT "OID", 1, ROW_NUMBER() OVER (ORDER BY "FECHA", "ID_COBRO") + 1000 AS "NROW", trim(to_char(ROW_NUMBER() OVER (ORDER BY "FECHA", "ID_COBRO") + 1000, '000000')), "FECHA"
	FROM "Cobro" 
	WHERE "OID" NOT IN (SELECT "OID_OPERACION" FROM "MovimientoBanco" WHERE "TIPO_OPERACION" = 1)
	AND "OID_CUENTA_BANCARIA" != 0
	ORDER BY "CODIGO";

INSERT INTO "MovimientoBanco" ("OID_OPERACION", "TIPO_OPERACION", "SERIAL", "CODIGO", "FECHA") 
	SELECT "OID", 3, ROW_NUMBER() OVER (ORDER BY "FECHA", "ID_PAGO") + 1220 AS "NROW", trim(to_char(ROW_NUMBER() OVER (ORDER BY "FECHA", "ID_PAGO") + 1220, '000000')), "FECHA"
	FROM "Pago" 
	WHERE "OID" NOT IN (SELECT "OID_OPERACION" FROM "MovimientoBanco" WHERE "TIPO_OPERACION" = 1)
	AND "OID_CUENTA_BANCARIA" != 0		
	ORDER BY "CODIGO";

INSERT INTO "MovimientoBanco" ("OID_OPERACION", "TIPO_OPERACION", "SERIAL", "CODIGO", "FECHA") 
	SELECT "OID", 2, ROW_NUMBER() OVER (ORDER BY "FECHA", "CODIGO") + 1362 AS "NROW", trim(to_char(ROW_NUMBER() OVER (ORDER BY "FECHA", "CODIGO") + 1362, '000000')), "FECHA"
	FROM "LineaCaja" 
	WHERE "OID" NOT IN (SELECT "OID_OPERACION" FROM "MovimientoBanco" WHERE "TIPO_OPERACION" = 1)
	AND "OID_CUENTA_BANCARIA" != 0
	ORDER BY "CODIGO";

UPDATE "MovimientoBanco" SET "SERIAL" = MV."NROW", "CODIGO" = trim(to_char(MV."NROW", '000000'))
FROM (SELECT "OID", ROW_NUMBER() OVER (ORDER BY "FECHA") AS "NROW"
     FROM "MovimientoBanco" 
     ORDER BY "FECHA") AS MV
WHERE "MovimientoBanco"."OID" = MV."OID";

ALTER TABLE "MovimientoBanco" DROP COLUMN "FECHA";

/* UPDATE 2.5.0.0*/

SET SEARCH_PATH = "COMMON";

ALTER TABLE "Cliente" ADD COLUMN "CUENTA_CONTABLE" text;
ALTER TABLE "Cliente" ADD COLUMN "OID_IMPUESTO" bigint;

SET SEARCH_PATH = "0001";

ALTER TABLE "ConceptoAlbaran" ADD COLUMN "OID_IMPUESTO" bigint;
ALTER TABLE "ConceptoFactura" ADD COLUMN "OID_IMPUESTO" bigint;
ALTER TABLE "Cobro" ADD COLUMN "OID_TPV" bigint;

/* UPDATE 3.0.0.0*/

SET SEARCH_PATH = "COMMON";

INSERT INTO "Variable" ("NAME", "VALUE") VALUES ('LAST_ENTRY', '1000');
INSERT INTO "Variable" ("NAME", "VALUE") VALUES ('JOURNAL', '1');
INSERT INTO "Variable" ("NAME", "VALUE") VALUES ('USE_TPV_COUNT', 'TRUE');
INSERT INTO "Variable" ("NAME", "VALUE") VALUES ('DEFAULT_SERIE_COMPRA', '1');

UPDATE "Cliente" SET "TIPO_ID" = 1 WHERE "TIPO_ID" = 0; 
UPDATE "Cliente" SET "TIPO_ID" = 0 WHERE "TIPO_ID" = 16; 

SET SEARCH_PATH = "0001";

ALTER TABLE "Caja" ADD COLUMN "CUENTA_CONTABLE" text;

ALTER TABLE "Cobro" ADD COLUMN "ESTADO" bigint DEFAULT 1;

UPDATE "ConceptoFactura" SET "OID_IMPUESTO" = IP."OID" 
FROM "COMMON"."Impuesto" AS IP
WHERE "ConceptoFactura"."P_IGIC" = IP."PORCENTAJE";

/*moleQule.Library.Store*/

/* UPDATE 3.0.0.0*/

SET SEARCH_PATH = "COMMON";

INSERT INTO "Variable" ("NAME", "VALUE") VALUES ('DEFAULT_SERIE_VENTA', '1');

ALTER TABLE "Familia" ADD COLUMN "OID_IMPUESTO" bigint;
ALTER TABLE "Serie" ADD COLUMN "OID_IMPUESTO" bigint;
ALTER TABLE "Despachante" ADD COLUMN "OID_IMPUESTO" bigint;
ALTER TABLE "Naviera" ADD COLUMN "OID_IMPUESTO" bigint;
ALTER TABLE "Proveedor" ADD COLUMN "OID_IMPUESTO" bigint;
ALTER TABLE "Transportista" ADD COLUMN "OID_IMPUESTO" bigint;


INSERT INTO "Impuesto" ("NOMBRE", "PORCENTAJE") VALUES ('EXENTO', 0.00);
INSERT INTO "Impuesto" ("NOMBRE", "PORCENTAJE") VALUES ('IGIC AL 2%', 2.00);
INSERT INTO "Impuesto" ("NOMBRE", "PORCENTAJE") VALUES ('IGIC AL 5%', 5.00);

UPDATE "Serie" SET "OID_IMPUESTO" = IP."OID" 
FROM "Impuesto" AS IP
WHERE "Serie"."IGIC" = IP."PORCENTAJE";

--ALTER TABLE "Impuesto" DROP COLUMN "IGIC";

ALTER TABLE "Serie" ADD COLUMN "TIPO" bigint DEFAULT 0;
ALTER TABLE "Serie" DROP COLUMN "IGIC";
ALTER TABLE "Serie" DROP COLUMN "VENTA";

UPDATE "Serie" SET "TIPO" = 3; 

ALTER TABLE "Familia" RENAME COLUMN "CUENTA_CONTABLE" TO "CUENTA_CONTABLE_COMPRA";
ALTER TABLE "Familia" ADD COLUMN "CUENTA_CONTABLE_VENTA" varchar(255);

UPDATE "Proveedor" SET "TIPO_ID" = 1 WHERE "TIPO_ID" = 0; 
UPDATE "Proveedor" SET "TIPO_ID" = 0 WHERE "TIPO_ID" = 16; 
UPDATE "Despachante" SET "TIPO_ID" = 1 WHERE "TIPO_ID" = 0; 
UPDATE "Despachante" SET "TIPO_ID" = 0 WHERE "TIPO_ID" = 16; 
UPDATE "Naviera" SET "TIPO_ID" = 1 WHERE "TIPO_ID" = 0; 
UPDATE "Naviera" SET "TIPO_ID" = 0 WHERE "TIPO_ID" = 16; 
UPDATE "Transportista" SET "TIPO_ID" = 1 WHERE "TIPO_ID" = 0; 
UPDATE "Transportista" SET "TIPO_ID" = 0 WHERE "TIPO_ID" = 16; 

SET SEARCH_PATH = "0001";

ALTER TABLE "Empleado" ADD COLUMN "OID_IMPUESTO" text;

ALTER TABLE "Producto" RENAME COLUMN "OID_IMPUESTO" TO "OID_IMPUESTO_COMPRA";
ALTER TABLE "Producto" ADD COLUMN "OID_IMPUESTO_VENTA" bigint;

ALTER TABLE "Pago" ADD COLUMN "GASTOS_BANCARIOS" decimal(10,2) DEFAULT 0;
ALTER TABLE "Pago" ADD COLUMN "ESTADO" bigint DEFAULT 1;

TRUNCATE TABLE "FacturaProveedor" CASCADE;
TRUNCATE TABLE "Factura" CASCADE;

TRUNCATE TABLE "Albaran_Factura" CASCADE;
TRUNCATE TABLE "Albaran_FacturaProveedor" CASCADE;

TRUNCATE TABLE "Albaran" CASCADE;
TRUNCATE TABLE "AlbaranProveedor" CASCADE;

ALTER TABLE "Producto" DROP COLUMN "NOMBRE_SERIE";
ALTER TABLE "Producto" DROP COLUMN "NUMERO_SERIE";

ALTER TABLE "Producto" ADD COLUMN "CUENTA_CONTABLE_COMPRA" varchar(255);
ALTER TABLE "Producto" ADD COLUMN "CUENTA_CONTABLE_VENTA" varchar(255);

ALTER TABLE "AlbaranProveedor" DROP CONSTRAINT "AlbaranProveedor_SERIAL_OID_SERIE_key";
ALTER TABLE "AlbaranProveedor" DROP CONSTRAINT "AlbaranProveedor_SERIAL_key";
ALTER TABLE "FacturaProveedor" DROP CONSTRAINT "FacturaProveedor_SERIAL_key";

ALTER TABLE "ConceptoProforma" ADD COLUMN "OID_IMPUESTO" bigint DEFAULT 0;

/*moleQule.Library.Common*/
/* UPDATE 3.1.0.0*/

SET SEARCH_PATH = "COMMON";

ALTER TABLE "MUNICIPIO" ADD COLUMN "PAIS" varchar(255);

UPDATE "MUNICIPIO" SET "PAIS" = 'ESPAÑA'; 

SET SEARCH_PATH = "0001";


/*moleQule.Library.Store*/

/* UPDATE 3.1.0.0*/

SET SEARCH_PATH = "COMMON";

SET SEARCH_PATH = "0001";

ALTER TABLE "Producto_Proveedor" RENAME COLUMN "OID_PROVEEDOR" TO "OID_ACREEDOR";
ALTER TABLE "Producto_Proveedor" ADD COLUMN "TIPO_ACREEDOR" bigint DEFAULT 0;
ALTER TABLE "Producto_Proveedor" ADD COLUMN "FACTURACION_BULTO" boolean DEFAULT FALSE;

UPDATE "Producto_Proveedor" SET "TIPO_ACREEDOR" = 1; 


/* UPDATE 3.2.0.0*/

SET SEARCH_PATH = "COMMON";

ALTER TABLE "Transportista" ADD COLUMN "TIPO_TRANSPORTISTA" bigint DEFAULT 0;

UPDATE "Transportista" SET "TIPO_TRANSPORTISTA" = 1 WHERE "DESTINO" = FALSE; 
UPDATE "Transportista" SET "TIPO_TRANSPORTISTA" = 2 WHERE "DESTINO" = TRUE; 

ALTER TABLE "Transportista" DROP COLUMN "DESTINO";

SET SEARCH_PATH = "0001";

ALTER TABLE "Expediente" ADD COLUMN "AYUDA" boolean DEFAULT TRUE;

UPDATE "Expediente" SET "AYUDA" = TRUE; 



